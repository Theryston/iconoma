name: version, tag and github release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.4.1

      - name: Install dependencies
        run: pnpm install

      - name: Check packages for version updates
        id: version-check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          packages_to_release=""
          for package_dir in packages/*/; do
            package_json="${package_dir}package.json"
            if [ -f "$package_json" ]; then
              package_name=$(node -p "JSON.parse(require('fs').readFileSync('$package_json', 'utf8')).name")
              package_version=$(node -p "JSON.parse(require('fs').readFileSync('$package_json', 'utf8')).version")
              is_private=$(node -p "(JSON.parse(require('fs').readFileSync('$package_json', 'utf8')).private || false).toString()")
              
              # Skip private packages
              if [ "$is_private" = "true" ]; then
                continue
              fi
              
              # Check if version already exists
              tag_name="v$package_version"
              exists=$(gh api repos/${{ github.repository }}/releases/tags/$tag_name >/dev/null 2>&1 && echo "true" || echo "")
              
              if [ -z "$exists" ]; then
                echo "Package $package_name version $package_version needs release"
                packages_to_release="$packages_to_release$package_dir|$package_name|$tag_name "
              else
                echo "Package $package_name version $tag_name already exists - skipping"
              fi
            fi
          done

          if [ -z "$packages_to_release" ]; then
            echo "No packages need releasing"
            echo "skipped=true" >> $GITHUB_OUTPUT
          else
            echo "skipped=false" >> $GITHUB_OUTPUT
            echo "packages=$packages_to_release" >> $GITHUB_OUTPUT
          fi

      - name: Setup git
        if: ${{ steps.version-check.outputs.skipped == 'false' }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Generate oclif README for CLI package
        if: ${{ steps.version-check.outputs.skipped == 'false' }}
        run: |
          if [ -d "packages/cli" ]; then
            cd packages/cli
            pnpm exec oclif readme || true
            cd ../..
            if [ -n "$(git status --porcelain)" ]; then
              git add .
              git commit -m "chore: update README.md" || true
              git push -u origin ${{ github.ref_name }} || true
            fi
          fi

      - name: Create Github Releases
        if: ${{ steps.version-check.outputs.skipped == 'false' }}
        env:
          GH_TOKEN: ${{ github.token }}
          PACKAGES: ${{ steps.version-check.outputs.packages }}
        run: |
          for package_info in $PACKAGES; do
            IFS='|' read -r package_dir package_name tag_name <<< "$package_info"
            echo "Creating release $tag_name for $package_name"
            gh release create "$tag_name" \
              --title "$tag_name" \
              --notes "Release $tag_name for $package_name" \
              --target ${{ github.ref_name }} || echo "Release $tag_name may already exist"
          done
